# Calendar Application
This project implements a React-based calendar application. The application displays a 3-week treatment program. In addition to the React application, this project also includes a server running, that receives the treatment program as JSON file, and calls the React app to visualize the data on a calendar interface.

## Scope of this project
* Frontend: A React-based app for rendering the calendar UI.
* Backend: A TypeScript/ExpressJs based server with endpoints to receive the program as JSON, and sends it to the frontend using Server-Sent Events (SSE) approach.
* Testing: This project implements basic unit tests on both server and UI side.
* Security: The project implements security features to ensure safe transmission of data.

## Project Structure
The project is divided into two main directories to separate the frontend and backend code, ensuring clear modularity and easier dependency management. Here is an overview of the structure with brief description.

```
/meru-health-app
|-- /client                     # Contains all frontend code (React).
|   |-- /src
|   |   |-- /components         # Includes all calendar-related components, and their test cases.
|   |   |-- /hooks              # Includes Server-side Events hooks for the React app to receive the program activity from server.
|   |   |-- /services           # Includes authentication service.
|   |   |-- /types              # Includes the data type for the Calendar UI.
|   |   |-- /utils              # Includes helper functions for processing calendar data, and their test cases.
|   |   |-- App.tsx             # Authenticates the app and displays the calendar if authentication is successful.
|   |   |-- index.tsx           
|   |-- /public                 # Public statuic files generated by the React app.
|   |-- .env.development        # Environmental variables. It is recommended not to share this file. However, this is present here to make the demo easier for others.
|   |-- jest.config.ts          # Jest based testing configuration.
|   |-- tsconfig.json           # TypeScript configuration.
|   |-- package.json            # Manages frontend dependencies and scripts.
|-- /server                     # Contains all backend code (Node.js/Express)
|   |-- /src
|   |   |-- /middlewares        # Authenticates the token received from the clients.
|   |   |-- /types              # Extension of the Request.
|   |   |-- /validators         # Includes a method that validates the JSON input to the server.
|   |   |-- server.js           # The main server file that configures and runs the Express server.
|   |-- /test                   # Unit test for the server.
|   |-- .env                    # Environmnetal variables. This should not be shared, however it is included for the demo.
|   |-- jest.config.ts          # Jest based testing configuration.
|   |-- package.json            # Manages backend-specific dependencies and scripts.
|   |-- tsconfig.json           # TypeScript configuration.

```

## Client-Side Application Overview
The client-side of the application is built using React, a powerful library for building user interfaces, coupled with TypeScript to ensure type safety and improve development efficiency. This setup is designed to provide a robust, maintainable, and scalable frontend architecture.

**Key Features and Configurations**:
1. **React and TypeScript Integration**: Utilizes React for its efficient rendering and state management capabilities, enhanced by TypeScript's static typing to catch errors at compile time.
2. **Dependency Management**:
    * **React**: Core library for building the UI.
    * **Axios**: Used for making HTTP requests to external services or APIs.
    * **Date-fns**: Provides utility functions for handling dates, critical for any application dealing with time calculations.
3. **Build and Testing Setup**:
   * Utilizes `react-scripts` for building and running the React application, which simplifies the setup of webpack and Babel.
    * **Jest and Testing Library**: Configured for testing with support for testing React components and hooks effectively. Enhanced with jest-date-mock for mocking date operations in tests.
4. **TypeScript Configuration**:
    * **Main Configuration** (`tsconfig.json`): Configures the compiler for JSX support, module resolution, and includes polyfills for modern JavaScript features.
    * **Jest Specific Configuration** (`tsconfig.jest.json`): Adapts TypeScript for Jest, setting modules to CommonJS and adjusting paths for test execution.
5. **Modern JavaScript Features**:
    * Configured to use the latest JavaScript features, ensuring the application can leverage the latest developments in the JavaScript ecosystem.
6. **Code Quality and Standards**:
    * **ESLint**: Integrated to maintain code quality and consistency, configured specifically for React and Jest.
    * **Type Definitions**: Includes type definitions for better development experience and integration with the existing JavaScript libraries.
7. **Development Environment**:
    * Defined scripts in `package.json` facilitate common tasks such as starting the development server, building the app, and running tests.
    * Environment configurations ensure that the app is optimized for both development and production environments, taking into consideration browser compatibility.

**Comments for Documentation within Each Client-Side File**

1. `index.tsx`:
Entry point for the React application. Sets up the React DOM rendering process and wraps the entire app in necessary providers (e.g., Redux, Context).

2. `App.tsx`:
Central component that orchestrates the rendering of the React application. Initializes key application routes and global state managers.

3. `Calendar.tsx`:
This component serves as the main display for the calendar, integrating individual day and weekday components to present a complete view. It manages state related to the current date and treatment programs, fetching data via server-sent events to update in real-time.

4. `Day.tsx`:
Represents a single day within the calendar. This component is responsible for displaying the day's date and any specific activities or events scheduled for that day. It interacts with the main calendar component to receive its props and handle user interactions effectively.

5. `Weekdays.tsx`:
Displays the days of the week as headers for the calendar. This static component enhances the calendarâ€™s user interface by providing a clear label for each column corresponding to days of the week.

6. `authService.ts`:
Manages authentication logic, including token storage and API requests for login and authentication verification.

7. `utility.ts`:
Contains utility functions that are used throughout the application to perform common tasks such as date manipulation, data transformation, and logic encapsulation.

8. `useSSE.ts`:
A custom hook designed to manage a server-sent events (SSE) connection. It abstracts the complexities of handling SSEs, providing components with a straightforward interface to receive real-time data.

9. `calendarTypes.ts`:
Defines TypeScript interfaces and types for the calendar functionality, ensuring type safety and consistency across components that deal with calendar data.


**Testing Files Overview**:

1. `Calendar.test.tsx`:
Tests the Calendar component's functionality, ensuring that it renders correctly, interacts with dependencies as expected, and handles state changes due to user actions or incoming data.

2. `Day.test.tsx`:
Focuses on verifying that the Day component accurately displays the data passed to it and reacts correctly to user inputs, such as clicks or other actions.

3. `Weekdays.test.tsx`:
Ensures that the Weekdays component correctly renders the days of the week, maintaining alignment and formatting regardless of the user's locale or settings.

4. `utility.test.ts`:
Contains tests for utility functions that support the application, ensuring that date calculations, data transformations, and other utility logic function correctly under various conditions.

## Server-side architecture

The server-side architecture of the application is structured around an Express.js framework, which facilitates the creation of robust APIs and web servers in a Node.js environment. The primary server file, `server.ts`, orchestrates the entire backend functionality, including API endpoint definitions, middleware configurations, and server initialization.

1. **Authentication and Security**: The server employs JSON Web Tokens (JWT) for authentication, which ensures secure transmission of information and verifies user access to protected routes. This is managed through the `authenticateToken.ts` middleware that decodes and validates tokens attached to incoming requests.

2. **Rate Limiting**: To safeguard against denial-of-service attacks and excessive API calls, the server utilizes `express-rate-limit`. This middleware restricts the number of requests a single client can make to the API within a set time frame, enhancing the overall security and performance.

3. **Environment Configuration**: Sensitive configuration values, such as the JWT secret key and database credentials, are managed securely using environment variables, which are loaded into the application through the `dotenv` package. This method helps in maintaining a secure and configurable environment across different deployment settings.

4. **Endpoint Validation**: The server includes a specific validation module, `validateTreatmentProgram.ts`, which checks the integrity and structure of the treatment program data submitted through the API. This validation ensures that the data adheres to predefined rules and structures, thus maintaining data integrity and consistency.

5. **Testing Configuration**: The server's functionality is ensured through comprehensive testing, configured in `jest.config.ts`. This setup allows for the rigorous testing of API endpoints and server logic, ensuring that all components behave as expected under various conditions.

6. **Type Safety and Compilation**: TypeScript is used to provide type safety and compile-time checks, enhancing the development experience and reducing runtime errors. The `tsconfig.json` file configures TypeScript compiler options to optimize the compilation process and output settings.

In summary, the server files collectively manage security, data validation, and configuration, ensuring that the backend is secure, robust, and efficient. They provide a well-structured foundation for handling requests, executing business logic, and responding to client interactions in a secure and scalable manner.

## Security Measures
This section provides a high-level overview of the security strategies implemented to protect the application and its data. Each measure is part of a comprehensive approach to secure the application from common vulnerabilities and attack vectors.
### JSON Web Tokens (JWT)
**Purpose**: Securely handle user sessions and requests by implementing JWT for authentication and authorization. Note that a default username and password are defined with which clients and servers interact with each other. These default values are specified in the environmental variable.

**Implementation**:
* Token Creation: JWTs are generated upon successful user authentication, embedding the user's identity in a digitally signed token.
* Token Verification: Every protected route validates the JWT before granting access, ensuring that requests are authenticated and authorized.
* Configuration: The secret key used for signing tokens is stored securely using environment variables and is never hardcoded into the application's source code.

### Rate Limiting
**Purpose**: Mitigate denial-of-service attacks and prevent abuse by limiting the rate of incoming requests from a single IP address.

**Implementation**:
* Library Used: express-rate-limit.
* Configuration: Requests are limited to 100 every 15 minutes per IP. Exceeding this limit results in a temporary block with a descriptive error message.

### Environment Variable Management
**Purpose**: Protect sensitive configuration options and secrets from exposure in the source code and version control.

**Implementation**:
* Dotenv Usage: Environment variables are managed using the dotenv package, allowing configuration settings to be stored in a .env file that is not included in version control.However, for this assignment it is included for demo purposes.
* Secure Handling: Critical secrets such as the JWT secret key, username and password are only referenced via environment variables, ensuring they are not exposed in the codebase.

### CORS
**Purpose**: Enhance application security by controlling cross-origin resource sharing.

**Implementation**:
* CORS Configuration: CORS is configured to allow requests only from specific, whitelisted domains, reducing the risk of cross-site request forgery.

## Input Format
This section outlines the validation process for the treatment program input in our application. Our goal is to ensure the data integrity and consistency of treatment programs submitted through our API.

### Overview of Validation Rules
The validation logic is designed to verify that the treatment program adheres to the specified structure and rules. This validation is done on the server side. Here are the key points covered in the validation step:

1. **Object Structure**: The treatment program must be a non-null object.
2. **Week Count**: The program should contain exactly three weeks.
3. **Consecutive Weeks**: Week numbers must be consecutive, starting from the first full week.
4. **Weekday Names**: Only valid weekday names are accepted (i.e., MONDAY to SUNDAY).
5. **Activity Fields**: Each activity must include a weekday, a title, and a completed status.
6. **Future Activities**: Activities set in the future must not be marked as completed.

The validation of treatment programs is a fundamental aspect of our API, ensuring that only logically and structurally correct data is processed. This approach minimizes errors and inconsistencies in handling treatment schedules, thereby enhancing the reliability of our application.

## API Endpoint Documentation
This section provides detailed documentation for each API endpoint included in our application. It outlines how to access and use the endpoints effectively for managing and retrieving treatment programs.

1. **Login Endpoint**
* Purpose: Authenticates users and provides a JWT for accessing protected endpoints.
* HTTP Method: POST
* Endpoint URL: /login
* Request Body:
```
{
  "username": "admin",
  "password": "admin123"
}
```
Response:

Success:
```
{
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
}
```
Error:
```
{
  "error": "Authentication failed: user does not exist or invalid password."
}
```
* Status Codes:
    * 200 OK on success
    * 401 Unauthorized if credentials are invalid
   
2. **Treatment Program Submission Endpoint**
* Purpose: Allows submission of new treatment programs.
* HTTP Method: POST
* Endpoint URL: /api/treatment
* Required Headers:
  * Authorization: Bearer <token>
  * Request Body:
    ```
    {
    "week1": [{"weekday": "MONDAY", "title": "Physical Therapy", "completed": false}],
    "week2": [{"weekday": "WEDNESDAY", "title": "Occupational Therapy", "completed": false}],
    "week3": [{"weekday": "FRIDAY", "title": "Speech Therapy", "completed": false}]
    }
    ```
  * Response:

    Success:
    ```
    {
        "message": "Treatment program received and stored successfully."
    }
    ```
    Error:
    ```
    {
        "error": "Invalid treatment program structure."
    }
    ```
* Status Codes:
    * 200 OK on successful submission
    * 400 Bad Request if the program structure is invalid
    * 401 Unauthorized if JWT is missing or invalid
  
3. **Treatment Program Retrieval Endpoint**
* Purpose: Retrieves the stored treatment program.
* HTTP Method: GET
* Endpoint URL: /api/treatment
* Required Headers:
  * Authorization: Bearer <token>
  * Response:

    Success:
    ```
    {
    "week1": [{"weekday": "MONDAY", "title": "Physical Therapy", "completed": false}],
    "week2": [{"weekday": "WEDNESDAY", "title": "Occupational Therapy", "completed": false}],
    "week3": [{"weekday": "FRIDAY", "title": "Speech Therapy", "completed": false}]
    }
    ```
    Error:
    ```
    {
    "error": "No treatment program available."
    }
    ```
* Status Codes:
    * 200 OK on success
    * 404 Not Found if no treatment program is available
    * 401 Unauthorized if JWT is missing or invalid

4. **Real-time Updates Endpoint (SSE)**
* Purpose: Provides real-time updates for treatment programs using Server-Sent Events.
* HTTP Method: GET
* Endpoint URL: /events
* Required Headers:
    * Authorization: Bearer <token>
    * Response:
        * Stream: Each event provides an update on the treatment program:
        ```
        data: {"week1": [{"weekday": "MONDAY", "title": "Physical Therapy", "completed": true}]}
        ```

## Setup and Installation
Clone the repository
```
git clone https://github.com/your-repo/my-app.git
cd my-app
// TODO: Checkout to the correct branch, fix the project name
```

Install the backend dependency, and make a build
```
cd server
npm install
npm run build
```

Start the server
```
npm start
```

To run test, use the command,
```
npm test
```

Now, install the frontend dependencies, run the build, and start the app
```
cd ..
cd client
npm install
npm run build
npm start
```

## Test
Assuming that the frontend and backend are already built with the `npm run build` command, the tests could be run for both with the command
```
npm test
```
Additionally, I would like to point out that my frontend test case for hook was failing because I could not mock the EventSource(). I would take a deeper look on that, and probably update this pull request, in the near future if I get time.

## Demo
Assuming that both client and server are running, follow these instructions to run the `example/program.json`.
For Winows environment, 

* open Powershell and first login to the server with the default username and password.
```
Invoke-WebRequest -Uri "http://localhost:5000/login" -Method Post -ContentType "application/json" -Body '{"username":"admin", "password":"admin123"}'
```
If successful, then the Powershell would receive a token.
```
$token = 'your_jwt_token_here' 
# For example, $token = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VybmFtZSI6ImFkbWluIiwiaWF0IjoxNzEzMzk2Mzk5LCJleHAiOjE3MTMzOTk5OTl9.5ELykszfWI9v42QNgoLpgF-cQJBBDwSKk_jT7BIIDiU'

# Setup the header with the authorization including the token
$headers = @{
    "Authorization" = "Bearer $token"
    "Content-Type" = "application/json"
}

# Making the POST request
Invoke-WebRequest -Uri "http://localhost:5000/api/treatment" -Method Post -Headers $headers -InFile ".\program.json"
```
Following the above steps, check the React app for the output.


## Conclusion
This project demonstrates the use of SSE in a full-stack JavaScript application to enable real-time data updates in a web application. Adjust configurations and troubleshoot with the provided guidelines to ensure robust operation.

## Additional text

Why TypeScript 4.9.5?
The project uses react-scripts@5.0.1, which has specific peer dependency requirements for TypeScript. Using TypeScript version 4.9.5 ensures that there are no compatibility issues with the build and tooling provided by react-scripts. Higher versions of TypeScript have led to conflicts during project setup and build processes, as identified during initial development attempts.